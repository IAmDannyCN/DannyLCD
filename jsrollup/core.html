<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DannyLCD</title>
    <style>
* {
    white-space: nowrap;
}

body {
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.module {
    display: block;
    visibility: hidden;
}

.BANNER_banner {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 800px;
    height: 151px;
    background : linear-gradient(0deg, rgba(255, 255, 255, 1) 0%, rgba(238, 238, 238, 1) 2.13%, rgba(183, 183, 183, 1) 9.75%, rgba(134, 134, 134, 1) 17.63%, rgba(93, 93, 93, 1) 25.6%, rgba(59, 59, 59, 1) 33.68%, rgba(33, 33, 33, 1) 41.9%, rgba(15, 15, 15, 1) 50.33%, rgba(4, 4, 4, 1) 59.09%, rgba(0, 0, 0, 1) 68.72%);
}

.BANNER_frame {
    position: absolute;
    background: #000000;
}
.BANNER_frame-type-zh {
    border-radius: 7px;
    position: absolute;
    left: 20px;
    top: 24px;
    width: 250px;
    height: 70px;
    box-sizing: border-box;
    padding-left: 2px;
    padding-right: 2px;
}
.BANNER_frame-type-en {
    border-radius: 5px;
    position: absolute;
    left: 20px;
    top: 100px;
    width: 182px;
    height: 30px;
    box-sizing: border-box;
    padding-left: 2px;
    padding-right: 2px;
}
.BANNER_frame-ti {
    border-radius: 5px;
    position: absolute;
    left: 206px;
    top: 100px;
    width: 64px;
    height: 30px;
    box-sizing: border-box;
    padding-left: 2px;
    padding-right: 2px;
}

.BANNER_text-type-zh {
    text-align: center;
    font-family: 微软雅黑;
    font-weight: bold;
    font-size: 50px;
    color: #FFFFFF;
    white-space: nowrap;
    transform-origin: left center;
}
.BANNER_text-type-en {
    text-align: center;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 22px;
    color : #FFFFFF;
    white-space: nowrap;
    transform-origin: left center; 
}
.BANNER_text-ti {
    text-align: center;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 22px;
    color : #FFFFFF;
    white-space: nowrap;
    transform-origin: left center; 
}

.BANNER_text {
    position: absolute;
    font-family : 微软雅黑;
    font-weight : bold;
    color : #FFFFFF;
    color : rgb(255, 255, 255);
    text-shadow: 
        1.5px 1.5px 0 #000000,
        -1.5px 1.5px 0 #000000,
        1.5px -1.5px 0 #000000,
        -1.5px -1.5px 0 #000000;
}
.BANNER_text-Wang {
    left: 270px;
    top: 10px;
    font-size : 100px;
}
.BANNER_text-Terminal-ZH {
    text-align: center;
    left: 536px;
    top: 60px;
    font-size : 70px;
    transform: translate(0%, -50%);
}
.BANNER_text-Terminal-EN {
    text-align: center;
    left: 536px;
    top: 115px;
    font-size : 25px;
    transform: translate(0%, -50%);
}

.A1_text-Xia {
    position: absolute;
    top: 405px;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 60px;
    color : #000000;
    transform: translate(0%, -50%);
}
.A1_text-ns {
    position: absolute;
    top: 450px;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 25px;
    color : #000000;
    transform: translate(0%, -50%);
}


.A2_line-svg {
    position: absolute;
    top: 0px;
    left: 0px;
}

.A2-LINE_frame_t0 {
    position: absolute;
    background : #FFFFFF;
    width : 66px;
    height : 41px;
    border-radius: 8px;
}

.A2-LINE_frame_t1 {
    position: absolute;
    background : #FFFFFF;
    width : 66px;
    height : 41px;
    border-radius: 8px;
}
.A2-LINE_text {
    text-align: center;
    font-family: Bahnschrift;
    font-weight: bold;
    font-size: 40px;
    color: #000000;
    white-space: nowrap;
    transform-origin: left center;

    box-sizing: border-box;
    padding-left: 2px;
    padding-right: 2px;
}
.A2-LINE_seg0 {
    position: absolute;
    background : #000000;
    width : 63px;
    height : 8px;
}
.A2-LINE_seg1 {
    position: absolute;
    background : #000000;
    width : 100px;
    height : 8px;
}
.A2-LINE_seg2 {
    position: absolute;
    background : #000000;
    width : 33px;
    height : 8px;
}

.A2-EN_text_0 {
    position: absolute;
    width: 45px;
    height: 190px;
    display: flex;
    flex-direction: column;
    transform-origin: top;
    writing-mode: vertical-lr;
    /* position: absolute;
    top: 120px;
    transform: rotate(90deg);
    transform-origin: left bottom; */
    font-family : 方正黑体_GBK;
    font-size : 40px;
    color : #ADADAD;
}
.A2-EN_text_1 {
    position: absolute;
    width: 45px;
    height: 190px;
    display: flex;
    flex-direction: column;
    transform-origin: top;
    writing-mode: vertical-lr;
    /* position: absolute;
    top: 120px;
    transform: rotate(90deg);
    transform-origin: left bottom; */
    font-family : 方正黑体_GBK;
    font-size : 40px;
    color : #000000;
}

.A2-ZH_text_0 {
    position: absolute;
    width: 45px;
    height: 190px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align-last: justify;
    writing-mode: vertical-lr;

    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 45px;
    color : #ADADAD;
    transform-origin: top;
}

.A2-ZH_text_1 {
    position: absolute;
    width: 45px;
    height: 190px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align-last: justify;
    writing-mode: vertical-lr;

    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 45px;
    color : #000000;
    transform-origin: top;
}

.B1_cur-ZH {
    position: absolute;
    font-family : 微软雅黑;
    font-weight : bold;
    /* font-size : 150px; */
    font-size: 130px;
    color : #000000;
}
.B1_cur-EN {
    position: absolute;
    font-family : 微软雅黑;
    font-weight : bold;
    /* font-size : 60px; */
    font-size: 45px;
    color : #000000;
}

.B2-3_frame {
    position: absolute;
    border-radius: 4.5px;
}
.B2-3_frame-type-zh {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 42.5px;
}
.B2-3_frame-type-en {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 21.9px;
}

.B2-3_frame-type-zh-1 {
    background: #000000;
    top: 210px;
}
.B2-3_frame-type-en-1 {
    background: #000000;
    top: 257px;
}
.B2-3_frame-type-zh-2 {
    background: #000000;
    top: 301px;
}
.B2-3_frame-type-en-2 {
    background: #000000;
    top: 348px;
}
.B2-3_frame-type-zh-3 {
    background: #000000;
    top: 392px;
}
.B2-3_frame-type-en-3 {
    background: #000000;
    top: 439px;
}

.B2-3_text-type-zh {
    text-align: center;
    font-family: 微软雅黑;
    font-weight: bold;
    font-size: 30px;
    color: #FFFFFF;
    white-space: nowrap;
    transform-origin: left center;
}
.B2-3_text-type-en {
    text-align: center;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 15px;
    color : #FFFFFF;
    white-space: nowrap;
    transform-origin: left center;
}

.B2-3_text-terminal-ZH {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 45px;
    color : #000000;
}
.B2-3_text-terminal-EN {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 20px;
    color : #000000;
}

.B2-3_text_t1 {
    position: absolute;
    top: 196px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-3_text_t2 {
    position: absolute;
    top: 287px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-3_text_t3 {
    position: absolute;
    top: 378px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.B2-3_text_p1 {
    position: absolute;
    top: 196px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-3_text_p2 {
    position: absolute;
    top: 287px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-3_text_p3 {
    position: absolute;
    top: 378px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.B2-2_frame {
    position: absolute;
    border-radius: 4.5px;
}
.B2-2_frame-type-zh {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 42.5px;
}
.B2-2_frame-type-en {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 21.9px;
}

.B2-2_frame-type-zh-1 {
    background: #000000;
    top: 260px;
}
.B2-2_frame-type-en-1 {
    background: #000000;
    top: 307px;
}
.B2-2_frame-type-zh-2 {
    background: #000000;
    top: 351px;
}
.B2-2_frame-type-en-2 {
    background: #000000;
    top: 398px;
}

.B2-2_text-type-zh {
    text-align: center;
    font-family: 微软雅黑;
    font-weight: bold;
    font-size: 30px;
    color: #FFFFFF;
    white-space: nowrap;
    transform-origin: left center;
}
.B2-2_text-type-en {
    text-align: center;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 15px;
    color : #FFFFFF;
    white-space: nowrap; 
    transform-origin: left center; 
}

.B2-2_text-terminal-ZH {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 45px;
    color : #000000;
}
.B2-2_text-terminal-EN {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 20px;
    color : #000000;
}

.B2-2_text_t1 {
    position: absolute;
    top: 246px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-2_text_t2 {
    position: absolute;
    top: 337px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.B2-2_text_p1 {
    position: absolute;
    top: 246px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}
.B2-2_text_p2 {
    position: absolute;
    top: 337px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.B2-1_frame {
    position: absolute;
    border-radius: 4.5px;
}
.B2-1_frame-type-zh {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 42.5px;
}
.B2-1_frame-type-en {
    position: absolute;
    left: 14px;
    width: 136px;
    height: 21.9px;
}

.B2-1_frame-type-zh-1 {
    background: #000000;
    top: 301px;
}
.B2-1_frame-type-en-1 {
    background: #000000;
    top: 348px;
}

.B2-1_text-type-zh {
    text-align: center;
    font-family: 微软雅黑;
    font-weight: bold;
    font-size: 30px;
    color: #FFFFFF;
    white-space: nowrap; 
    transform-origin: left center; 
}
.B2-1_text-type-en {
    text-align: center;
    font-family : 微软雅黑;
    font-weight : bold;
    font-size : 15px;
    color : #FFFFFF;
    white-space: nowrap; 
    transform-origin: left center; 
}

.B2-1_text-terminal-ZH {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 45px;
    color : #000000;
}
.B2-1_text-terminal-EN {
    position: absolute;
    left: 302px;
    font-family : 方正黑体_GBK;
    font-size : 20px;
    color : #000000;
}

.B2-1_text_t1 {
    position: absolute;
    top: 287px;
    left: 522px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.B2-1_text_p1 {
    position: absolute;
    top: 287px;
    left: 664px;

    text-align: center;
    font-family : Bahnschrift;
    letter-spacing: -5px;
    font-size : 90px;
    color : #000000;
}

.fullscreen-svg {
    width: 800px;
    height: 480px;
    position: absolute;
    top: 0px;
    left: 0px;
}

.transferA-svg {
    width: 41px;
    height: 41px;
    position: absolute;
}

.transferB-svg {
    width: 55px;
    height: 41px;
    position: absolute;
}

.shadow-svg {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 800px;
    height: 480px;
}

.dot-svg {
    width: 54px;
    height: 54px;
    position: absolute;
}

.inner-shadow-svg {
    position: absolute;
}
.inner-shadow-svg-const {
    position: absolute;
}
    </style>
    <script>
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

const maxWidthDict = {
    '.BANNER_text-type-zh': 225,
    '.BANNER_text-type-en': 170,
    '.BANNER_text-Terminal-ZH': 500,
    '.BANNER_text-Terminal-EN': 480,
    '.A1_text-Xia': 300,
    '.A1_text-ns': 300,
    '.A2-ZH_text_0': 190,
    '.A2-ZH_text_1': 190,
    '.A2-EN_text_0': 180,
    '.A2-EN_text_1': 180,
    '.A2-LINE_text': 62,
    '.B1_cur-ZH': 600,
    '.B1_cur-EN': 700,
    '.B2-3_text-type-zh': 135,
    '.B2-3_text-type-en': 129,
    '.B2-3_text-terminal-ZH': 210,
    '.B2-3_text-terminal-EN': 210,
    '.B2-3_text_t1': 90,
    '.B2-3_text_t2': 90,
    '.B2-3_text_t3': 90,
    '.B2-3_text_p1': 70,
    '.B2-3_text_p2': 70,
    '.B2-3_text_p3': 70,
    '.B2-2_text-type-zh': 135,
    '.B2-2_text-type-en': 129,
    '.B2-2_text-terminal-ZH': 210,
    '.B2-2_text-terminal-EN': 210,
    '.B2-2_text_t1': 90,
    '.B2-2_text_t2': 90,
    '.B2-2_text_p1': 70,
    '.B2-2_text_p2': 70,
    '.B2-1_text-type-zh': 135,
    '.B2-1_text-type-en': 129,
    '.B2-1_text-terminal-ZH': 210,
    '.B2-1_text-terminal-EN': 210,
    '.B2-1_text_t1': 90,
    '.B2-1_text_p1': 70,
};
scaleYList = ['.A2-ZH_text_0', '.A2-ZH_text_1', '.A2-EN_text_0', '.A2-EN_text_1'];
transformXList = [  '.BANNER_text-Terminal-ZH', '.BANNER_text-Terminal-EN',
                    '.A1_text-Xia', '.A1_text-ns',
                    '.B1_cur-ZH', '.B1_cur-EN',
                    '.B2-3_text-terminal-ZH', '.B2-3_text-terminal-EN',
                    '.B2-3_text_t1', '.B2-3_text_t2', '.B2-3_text_t3',
                    '.B2-3_text_p1', '.B2-3_text_p2', '.B2-3_text_p3',
                    '.B2-2_text-terminal-ZH', '.B2-2_text-terminal-EN',
                    '.B2-2_text_t1', '.B2-2_text_t2',
                    '.B2-2_text_p1', '.B2-2_text_p2',
                    '.B2-1_text-terminal-ZH', '.B2-1_text-terminal-EN',
                    '.B2-1_text_t1',
                    '.B2-1_text_p1',
                ]

function getFontStyles(element) {
    const computedStyle = getComputedStyle(element);
    return {
        fontFamily: computedStyle.fontFamily,
        fontSize: computedStyle.fontSize,
    };
}

function show_module(moduleId) {
    const targetModule = document.getElementById(moduleId);
    if (targetModule) {
        targetModule.style.visibility = 'visible';
    }
}

function hide_module(moduleId) {
    const targetModule = document.getElementById(moduleId);
    if (targetModule) {
        targetModule.style.visibility = 'hidden';
    }
}

function clear_svg(svg_class) {
    var svgs = document.querySelectorAll(svg_class);
    svgs.forEach(function(svg) {
        svg.remove();
    });
}

function reset_module(skip_list=[], clear_transfer_svg=true, show_banner=true) {

    clear_svg('.fullscreen-svg');
    clear_svg('.dot-svg');
    clear_svg('.inner-shadow-svg');
    if(clear_transfer_svg) {
        clear_svg('.transferA-svg');
        clear_svg('.transferB-svg');
    }

    const modules = document.querySelectorAll('.module');
    modules.forEach(module => {
        if(!skip_list.includes(module.id)) {
            module.style.visibility = 'hidden';
        }
    });

    if(show_banner) {
        show_module('banner');
    }
}

function change_scaleX(element_id, target_scaleX, is_scaleY, is_transformX) {
    const element = document.getElementById(element_id);
    const currentTransform = window.getComputedStyle(element).transform;

    // 如果没有transform样式，初始化为空矩阵
    if (currentTransform === 'none') {
        element.style.transform = `matrix(1, 0, 0, 1, 0, 0)`;
        // return;
    }

    const matrix = new DOMMatrix(currentTransform);
    
    if(!is_scaleY) {
        matrix.a = target_scaleX;
    } else {
        matrix.d = target_scaleX;
    }
    
    if(is_transformX) {
        matrix.e = -0.5 * element.offsetWidth;
    }

    // console.log(element_id, is_scaleY, is_transformX);
    // console.log(window.getComputedStyle(document.getElementById(element_id)).transform);

    element.style.transform = matrix.toString();

    // console.log(window.getComputedStyle(document.getElementById(element_id)).transform);
}

function updateTextScale() {
    Object.entries(maxWidthDict).forEach(([className, maxWidth]) => {
        const textElements = document.querySelectorAll(className);
        
        textElements.forEach(element => {
            const text = element.textContent;

            const { fontFamily, fontSize } = getFontStyles(element);
            
            ctx.font = `${fontSize} ${fontFamily}`;
            
            const textWidth = ctx.measureText(text).width;
            const scaleValue = textWidth > maxWidth ? maxWidth / textWidth : 1;
            
            change_scaleX(element.id, scaleValue, scaleYList.includes(className), transformXList.includes(className));
        });
    });
}

function changesvgscale(svg_id, target_width, target_height) {
    const svgObject = document.getElementById(svg_id);
    
    if (svgObject) {
        svgObject.onload = function() {
            const svgContent = svgObject.contentDocument;
            const svgElem = svgContent.querySelector('svg');

            svgElem.setAttribute('width', target_width);
            svgElem.setAttribute('height', target_height);

            svgElem.removeAttribute('viewBox');
        };
    } else {
        console.error("SVG element with the specified id not found.");
    }
}

function updateTime() {
    // var now = new Date();
    // var hours = now.getHours().toString().padStart(2, '0');
    // var minutes = now.getMinutes().toString().padStart(2, '0');
    // var timeString = hours + ':' + minutes;
    var curTime = getTime();
    var timeString = curTime.slice(0,2) + ":" + curTime.slice(2, 4);
    
    document.getElementById('BANNER_text-ti').textContent = timeString;
}

function sleep(s) {
    return new Promise(resolve => setTimeout(resolve, s * 1000));
}

function getTrainId() {
    const params = new URLSearchParams(window.location.search);
    let trainId = params.get('trainId');
    return trainId == null ? "" : trainId;
}

function getRealTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    return hours + minutes + seconds;
}

function getInterval(t1, t2) {
    return 3600 * (parseInt(t2.substring(0, 2)) - parseInt(t1.substring(0, 2))) + 
           60 * (parseInt(t2.substring(2, 4)) - parseInt(t1.substring(2, 4))) + 
           (parseInt(t2.substring(4, 6)) - parseInt(t1.substring(4, 6)));
}

function getTimeOffset() {
    const params = new URLSearchParams(window.location.search);
    let expectedTime = params.get('time');
    try {
        let result = getInterval(getRealTime(), expectedTime);
        return (Number.isFinite(result) && !isNaN(result)) ? result : 0;
    } catch (error) {
        return 0;
    }
    
}

var timeOffset = 0;
function getTime() {
    var realTime = new Date();
    var modifiedTime = new Date(realTime.getTime() + timeOffset * 1000);
    const hours = String(modifiedTime.getHours()).padStart(2, '0');
    const minutes = String(modifiedTime.getMinutes()).padStart(2, '0');
    const seconds = String(modifiedTime.getSeconds()).padStart(2, '0');
    return hours + minutes + seconds;
}
    </script>
    <!-- <script src="./socket.js"></script> -->
    <script>
const lineJsonFile = "line.json";
const trainJsonFile = "train.json";
const curTrainId = getTrainId();

var curTrainPre, curTrain;
var stationDataById = {}, lineDataById = {}, trainDataById = {};
var curLines;

const lineData = window.parent.lineData;
const trainData = window.parent.trainData;

const getContent = window.parent.getContent;

function show(name) {
    updateTextScale();
    show_module(`${name}`);
}
function hide(name) {
    hide_module(`${name}`);
}
function reset(name = 'banner', skipList = [], clearTransferSvg = true) {
    reset_module(skipList, clearTransferSvg);
    show(name);
}
async function display(name, skipList = [], sleepTime = 0, targetTime = "999999", clearTransferSvg = true) {
    reset(name, skipList, clearTransferSvg);
    if (sleepTime !== 0) {
        await sleep(Math.min(sleepTime, getInterval(getTime(), targetTime)));
    }
}
function addShadowSvg(svgName, svgId, moduleName) {
    // const addFullScreenSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', '${svgName}');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('fullscreen-svg');
    // svgObject.setAttribute('id', '${svgId}');
    // document.body.appendChild(svgObject);
    // `;
    const addShadowSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['${svgName}'];
    svgObject.classList.add('shadow-svg');
    svgObject.setAttribute('id', '${svgId}');
    document.getElementById('${moduleName}').appendChild(svgObject);
    `;
    eval(addShadowSvgCode);
}
function addFullScreenSvg(svgName, svgId) {
    // const addFullScreenSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', '${svgName}');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('fullscreen-svg');
    // svgObject.setAttribute('id', '${svgId}');
    // document.body.appendChild(svgObject);
    // `;
    const addFullScreenSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['${svgName}'];
    svgObject.classList.add('fullscreen-svg');
    svgObject.setAttribute('id', '${svgId}');
    svgObject.style.zIndex = 9998;
    document.body.appendChild(svgObject);
    `;
    eval(addFullScreenSvgCode);
}
function addTransferASvg(svgName, svgId, moduleName, top, left, scale = 1) {
    // const addSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', '${svgName}');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('transferA-svg');
    // svgObject.setAttribute('id', '${svgId}');
    // svgObject.style.top = '${top}px';
    // svgObject.style.left = '${left}px';
    // svgObject.style.transform = 'scale(${scale})';
    // document.getElementById('${moduleName}').appendChild(svgObject);
    // `;
    const addSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['${svgName}'];
    svgObject.classList.add('transferA-svg');
    svgObject.setAttribute('id', '${svgId}');
    svgObject.style.position = 'absolute';
    svgObject.style.top = '${top}px';
    svgObject.style.left = '${left}px';
    svgObject.style.transform = 'scale(${scale})';
    document.getElementById('${moduleName}').appendChild(svgObject);
    `;
    eval(addSvgCode);
}
function addTransferBSvg(svgName, svgId, moduleName, top, left, scale = 1) {
    // const addSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', '${svgName}');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('transferB-svg');
    // svgObject.setAttribute('id', '${svgId}');
    // svgObject.style.top = '${top}px';
    // svgObject.style.left = '${left}px';
    // svgObject.style.transform = 'scale(${scale})';
    // document.getElementById('${moduleName}').appendChild(svgObject);
    // `;
    const addSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['${svgName}'];
    svgObject.classList.add('transferB-svg');
    svgObject.setAttribute('id', '${svgId}');
    svgObject.style.position = 'absolute';
    svgObject.style.top = '${top}px';
    svgObject.style.left = '${left}px';
    svgObject.style.transform = 'scale(${scale})';
    document.getElementById('${moduleName}').appendChild(svgObject);
    `;
    eval(addSvgCode);
}
function addDotSvg(mapPos) {
    // const addSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', 'SVG/A1-dot.svg');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('dot-svg');
    // svgObject.setAttribute('id', 'dot-svg');
    // svgObject.style.top = '${mapPos[0] - 54 / 2}px';
    // svgObject.style.left = '${mapPos[1] - 54 / 2}px';
    // svgObject.style.transform = 'scale(0.75)';
    // svgObject.style.transformOrigin = '50% 50%';
    // svgObject.style.zIndex = 9999;
    // document.getElementById('A1').appendChild(svgObject);
    // `;
    const addSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['SVG/A1-dot.svg'];
    svgObject.classList.add('dot-svg');
    svgObject.setAttribute('id', 'dot-svg');
    svgObject.style.position = 'absolute';
    svgObject.style.top = '${mapPos[0] - 54 / 2}px';
    svgObject.style.left = '${mapPos[1] - 54 / 2}px';
    svgObject.style.transform = 'scale(0.75)';
    svgObject.style.transformOrigin = '50% 50%';
    svgObject.style.zIndex = 9999;
    document.getElementById('A1').appendChild(svgObject);
    `;
    eval(addSvgCode);
}
function addInnerShadowSvg(svgName, svgId, top, left, width, height, moduleName, isConst) {
    const svgClass = isConst ? "inner-shadow-svg-const" : "inner-shadow-svg";
    // const addInnerShadowSvgCode = `
    // const svgObject = document.createElement('object');
    // svgObject.setAttribute('data', 'SVG/${svgName}.svg');
    // svgObject.setAttribute('type', 'image/svg+xml');
    // svgObject.classList.add('${svgClass}');
    // svgObject.setAttribute('id', '${svgId}');
    // svgObject.style.top = '${top}px';
    // svgObject.style.left = '${left}px';
    // svgObject.style.width = '${width}px';
    // svgObject.style.height = '${height}px';
    // svgObject.style.zIndex = 9999;
    // document.getElementById('${moduleName}').appendChild(svgObject);
    // `;
    const addInnerShadowSvgCode = `
    const svgObject = document.createElement('div');
    svgObject.innerHTML = getContent['SVG/${svgName}.svg'];
    svgObject.classList.add('${svgClass}');
    svgObject.setAttribute('id', '${svgId}');
    svgObject.style.position = 'absolute';
    svgObject.style.top = '${top}px';
    svgObject.style.left = '${left}px';
    svgObject.style.width = '${width}px';
    svgObject.style.height = '${height}px';
    svgObject.style.zIndex = 9999;
    document.getElementById('${moduleName}').appendChild(svgObject);
    `;
    eval(addInnerShadowSvgCode);
}
function delByClass(className) {
    const delbyclassCode = `
    const elements = document.querySelectorAll('.${className}');
    elements.forEach(element => element.remove());
    `;
    eval(delbyclassCode);
}
function delById(idName) {
    const delbyidCode = `const element = document.getElementById('${idName}');` + `
    if (element) { element.remove(); }
    `;
    eval(delbyidCode);
}
function showById(idName) {
    const showbyidCode = `document.getElementById("${idName}").style.display = "block";`;
    eval(showbyidCode);
}
function hideById(idName) {
    const hidebyidCode = `document.getElementById("${idName}").style.display = "none";`;
    eval(hidebyidCode);
}
function changeAttribute(idName, attributeName, content) {
    const changeCode = `document.getElementById("${idName}").${attributeName} = "${content}";`;
    eval(changeCode);
}
function changeContent(idName, content) {
    changeAttribute(idName, "textContent", content);
}
function changeClass(idName, className) {
    changeAttribute(idName, "className", className);
}
function changeBg(idName, background) {
    changeAttribute(idName, "style.background", background);
}
function changeBgImg(className, background) {
    document.querySelector(`${className}`).style.backgroundImage = `${background}`;
}
function getStatus(curTime) {
    for (let idx = 0; idx < curTrain.length; idx++) {
        const plan = curTrain[idx];
        if (curTime < plan.t1) {
            return [idx, "A"];
        } else if (curTime < plan.t2) {
            return [idx, "B"];
        }
    }
    return [curTrain.length, "C"];
}
function getStationInfo(stationId) {
    for (let i = 0; i < lineData.station.length; i++) {
        const station = lineData.station[i];
        if (station.id === stationId) {
            return station;
        }
    }
    return {
        id: stationId,
        "name-ZH": `${stationId}号站`,
        "name-EN": `Station ID ${stationId}`,
        "lines": []
    };
}
function getTrainName(trainId) {
    const header = trainId[0];
    const identifier = trainId.slice(1, 3);
    
    if (header === "L") {
        if (identifier === "06") {
            return ["6号线", "Line 6 Local"];
        } else if (identifier === "S6") {
            return ["S6号线", "Line S6 Local"];
        } else if (identifier === "R4") {
            return ["R4号线", "Line R4 Local"];
        } else if (identifier === "R9") {
            return ["R9号线", "Line R9 Local"];
        } else if (identifier === "04") {
            return ["4号线", "Line 4 Local"];
        }
    } else if (header === "R") {
        if (identifier === "XF") {
            return ["新发快速", "XINFA Rapid"];
        } else if (identifier === "JC") {
            return ["机场快速", "Airport Rapid"];
        } else if (identifier === "WL") {
            return ["卧龙快速", "WOLONG Rapid"];
        } else if (identifier === "GX") {
            return ["高新快速", "High-Tech Zone Rapid"];
        }
    } else if (header === "E") {
        if (identifier === "WL") {
            return ["卧龙特快", "WOLONG Express"];
        }
    }
}
function getSvgName(trainId) {
    if (trainId.slice(0, 3) === "L06") {
        return "A1-LOCAL6";
    } else if (trainId.slice(0, 3) === "LS6") {
        return "A1-LOCALS6";
    } else if (trainId.slice(0, 3) === "LR9") {
        return "A1-LOCALR9";
    } else if (trainId.slice(0, 3) === "LR4") {
        const trainData = trainDataById[trainId]["train"];
        const station = trainData[0]["plan"][0]["station"];
        const lastStation = trainData[trainData.length - 1]["plan"][trainData[trainData.length - 1]["plan"].length - 1]["station"];
        if (station === "00019" || lastStation === "00019") {
            return "A1-LOCALR4";
        } else {
            return "A1-LOCALR4short";
        }
    } else if (trainId.slice(0, 3) === "RJC") {
        return "A1-RAPID46";
    } else if (trainId.slice(0, 3) === "RXF") {
        return "A1-RAPID6R9";
    } else if (trainId.slice(0, 3) === "RGX") {
        return "A1-RAPIDS6R4";
    } else if (trainId.slice(0, 3) === "RWL") {
        return "A1-RAPID6S6";
    } else if (trainId.slice(0, 3) === "EWL") {
        return "A1-RAPID6S6";
    }
}
function getA2SvgATransform(num) {
    let transform = [];
    if (num === 1) {
        transform.push({
            "top": 453 - 41 / 2,
            "left": 63 - 41 / 2,
            "scale": 1
        });
    } else if (num === 2) {
        transform.push({
            "top": 453 - 41 / 2,
            "left": 63 - 41 / 2 - 23,
            "scale": 1
        });
        transform.push({
            "top": 453 - 41 / 2,
            "left": 63 - 41 / 2 + 23,
            "scale": 1
        });
    } else {
        let upperNum = Math.floor(num / 2);
        let lowerNum = num - upperNum;
        for (let i = 0; i < upperNum; i++) {
            transform.push({
                "top": 453 - 41 / 2 - 12,
                "left": 63 - 41 / 2 - 25 * (upperNum - 1) / 2 + 25 * i,
                "scale": 0.6
            });
        }
        for (let i = 0; i < lowerNum; i++) {
            transform.push({
                "top": 453 - 41 / 2 + 13,
                "left": 63 - 41 / 2 - 25 * (lowerNum - 1) / 2 + 25 * i,
                "scale": 0.6
            });
        }
    }
    return transform;
}
function getB1SvgTransform(num) {
    let transform = [];
    for (let i = 0; i < num; i++) {
        transform.push([{
            "top": 410,
            "left": 400 - 30 - 185 * (num - 1) / 2 + 185 * i - 35,
            "scale": 1.5
        }, {
            "top": 410,
            "left": 400 - 30 - 185 * (num - 1) / 2 + 185 * i + 35,
            "scale": 1.5
        }]);
    }
    return transform;
}
function displayBanner() {
    let [trainNameZH, trainNameEN] = getTrainName(curTrainPre["id"]);
    addInnerShadowSvg("banner-inner-shadow", "BANNER_inner-shadow",
                     24, 20, 250, 106,
                     "banner", true);
    changeContent("BANNER_text-type-zh", trainNameZH);
    changeContent("BANNER_text-type-en", trainNameEN);
    // changeContent("BANNER_text-Terminal-ZH", stationDataById[curTrain[curTrain.length - 1]["id"]]["name-ZH"]);
    // changeContent("BANNER_text-Terminal-EN", "To " + stationDataById[curTrain[curTrain.length - 1]["id"]]["name-EN"]);
    changeBg("BANNER_frame-ZH", curTrainPre["color"]);
    changeBg("BANNER_frame-EN", curTrainPre["color"]);
    changeBg("BANNER_frame-ti", curTrainPre["color"]);
    let col = curTrainPre["subcolor"];
    let colr = parseInt(col.substring(1, 3), 16) / 255;
    let colg = parseInt(col.substring(3, 5), 16) / 255;
    let colb = parseInt(col.substring(5, 7), 16) / 255;
    changeBgImg(".BANNER_banner", `linear-gradient(0deg, rgba(255, 255, 255, 1) 0%, rgba(${Math.floor(238 + colr * 17)}, ${Math.floor(238 + colg * 17)}, ${Math.floor(238 + colb * 17)}, 1) 2.13%, rgba(${Math.floor(183 + colr * 72)}, ${Math.floor(183 + colg * 72)}, ${Math.floor(183 + colb * 72)}, 1) 9.75%, rgba(${Math.floor(134 + colr * 121)}, ${Math.floor(134 + colg * 121)}, ${Math.floor(134 + colb * 121)}, 1) 17.63%, rgba(${Math.floor(93 + colr * 162)}, ${Math.floor(93 + colg * 162)}, ${Math.floor(93 + colb * 162)}, 1) 25.6%, rgba(${Math.floor(59 + colr * 196)}, ${Math.floor(59 + colg * 196)}, ${Math.floor(59 + colb * 196)}, 1) 33.68%, rgba(${Math.floor(33 + colr * 222)}, ${Math.floor(33 + colg * 222)}, ${Math.floor(33 + colb * 222)}, 1) 41.9%, rgba(${Math.floor(15 + colr * 240)}, ${Math.floor(15 + colg * 240)}, ${Math.floor(15 + colb * 240)}, 1) 50.33%, rgba(${Math.floor(4 + colr * 251)}, ${Math.floor(4 + colg * 251)}, ${Math.floor(4 + colb * 251)}, 1) 59.09%, rgba(${Math.floor(colr * 255)}, ${Math.floor(colg * 255)}, ${Math.floor(colb * 255)}, 1) 68.72%)`);
    show("banner");
}
function updateBanner(nextZH, nextEN, terminal=false) {
    if (terminal) {
        changeContent("BANNER_text-Terminal-ZH", nextZH);
        changeContent("BANNER_text-Terminal-EN", nextEN);
    } else {
        changeContent("BANNER_text-Terminal-ZH", "下一站 " + nextZH);
        changeContent("BANNER_text-Terminal-EN", "Next Station: " + nextEN);
    }
}
async function displayA1(plan, sleepTime=0, targetTime="999999") {
    reset("A1");
    if (sleepTime !== 0) {
        await sleep(Math.min(sleepTime, getInterval(getTime(), targetTime)));
    }
}
async function displayA2(pastStations, futureStations, targetTime) {
    let beginColor = curTrainPre["color"];
    let endColorFlag = false;
    changeBg("A2-LINE_seg_7", beginColor);
    
    if (futureStations.length > 7) {
        futureStations = futureStations.slice(0, 7);
        endColorFlag = true;
    }
    if (pastStations.length > 7 - futureStations.length) {
        if (pastStations.length > 8 - futureStations.length) {
            let beginStation = pastStations[pastStations.length - (8 - futureStations.length)];
            beginColor = lineDataById[beginStation["line"]]["color"];
        }
        pastStations = pastStations.slice(pastStations.length - (7 - futureStations.length));
    }
    
    let displayStations = [];
    for (let i = 0; i < (7 - futureStations.length - pastStations.length); i++) {
        displayStations.push({
            "type": 0,
            "name-ZH": "",
            "name-EN": "",
            "t1": "000000",
            "line": "0",
            "color": "#ADADAD",
            "transfer": []
        });
    }

    pastStations.forEach(station => {
        displayStations.push({
            "type": 1,
            "name-ZH": stationDataById[station["id"]]["name-ZH"],
            "name-EN": stationDataById[station["id"]]["name-EN"],
            "t1": station["t1"],
            "line": lineDataById[station["line"]]["id"],
            "color": lineDataById[station["line"]]["color"],
            "transfer": stationDataById[station["id"]]["lines"]
        });
    });

    futureStations.forEach(station => {
        displayStations.push({
            "type": 2,
            "name-ZH": stationDataById[station["id"]]["name-ZH"],
            "name-EN": stationDataById[station["id"]]["name-EN"],
            "t1": station["t1"],
            "line": lineDataById[station["line"]]["id"],
            "color": lineDataById[station["line"]]["color"],
            "transfer": stationDataById[station["id"]]["lines"]
        });
    });

    displayStations.forEach((station, i) => {
        // above line
        if (station["type"] === 0 || station["type"] === 1) {
            changeClass(`A2-LINE_frame_${i}`, "A2-LINE_frame_t0");
            changeClass(`A2-EN_block_${i}`, "A2-EN_text_0");
            changeClass(`A2-ZH_block_${i}`, "A2-ZH_text_0");
            changeContent(`A2-LINE_t${i}`, "");
        } else {
            changeClass(`A2-LINE_frame_${i}`, "A2-LINE_frame_t1");
            changeClass(`A2-EN_block_${i}`, "A2-EN_text_1");
            changeClass(`A2-ZH_block_${i}`, "A2-ZH_text_1");
            let timeInterval = Math.ceil(getInterval(getTime(), station["t1"]) / 60);
            if (timeInterval < 0 || timeInterval > 999) {
                changeContent(`A2-LINE_t${i}`, "--");
            } else {
                changeContent(`A2-LINE_t${i}`, `${timeInterval}`);
            }
        }

        // line
        changeContent(`A2-ZH_block_${i}`, station["name-ZH"]);
        changeContent(`A2-EN_block_${i}`, station["name-EN"]);
        if (i !== 6 || (i === 6 && endColorFlag)) {
            changeBg(`A2-LINE_seg_${i + 1}`, station["color"]);
        }

        // below line
        if (station["type"] !== 0) {
            let transfer = station["transfer"].filter(line => !curLines.includes(line));
            if (transfer.length === 0) {
                return;
            }
            let transform = getA2SvgATransform(transfer.length);
            transfer.forEach((line, lineIdx) => {
                addTransferASvg(`SVG/${line}-1.svg`, `A2-transferA-${i}-${lineIdx}`, "A2-line",
                                 transform[lineIdx]["top"], transform[lineIdx]["left"] + 100 * i, transform[lineIdx]["scale"]);
            });
        }
    });

    changeBg("A2-LINE_seg_0", beginColor);
    if (curTrainPre["id"][0] === "L") {
        for (let i = 0; i < 8; i++) {
            changeBg(`A2-LINE_seg_${i}`, curTrainPre["subcolor"]);
        }
    }

    let color = curTrainPre["color"];
    document.getElementById("A2-line-svg").getElementsByTagName("polygon")[0].setAttribute("fill", color);
    reset("A2-line", [], false);
    await display("A2-ZH", ["A2-line"], 10, targetTime, false);
    await display("A2-EN", ["A2-line"], 10, targetTime, false);
}
async function displayB1(station, showTime, targetTime) {
    changeContent("B1_cur-ZH", station["name-ZH"]);
    changeContent("B1_cur-EN", station["name-EN"]);
    
    let transfer = station["lines"].filter(line => !curLines.includes(line));
    let transform = getB1SvgTransform(transfer.length);

    if (transfer.length === 0) {
        document.getElementById('B1_cur-ZH').style.top = '180px';
        document.getElementById('B1_cur-EN').style.top = '350px';
        document.getElementById('B1-transfershadow').style.display = 'none';
    } else {
        document.getElementById('B1_cur-ZH').style.top = '140px';
        document.getElementById('B1_cur-EN').style.top = '300px';
        document.getElementById('B1-transfershadow').style.display = 'block';
    }

    reset("B1");

    transfer.forEach((line, lineIdx) => {
        addTransferASvg(`SVG/${line}-1.svg`, `B1-transferA-${lineIdx}`, "B1", 
                        transform[lineIdx][0]["top"], transform[lineIdx][0]["left"], transform[lineIdx][0]["scale"]);
        addTransferBSvg(`SVG/${line}-2.svg`, `B1-transferB-${lineIdx}`, "B1", 
                        transform[lineIdx][1]["top"], transform[lineIdx][1]["left"], transform[lineIdx][1]["scale"]);
    });

    let interval = getInterval(getTime(), targetTime);
    await sleep(Math.min(showTime, interval));
}
function prepareB2(stationId, curDir, curTime) {
    let candidateDict = {};
    let curType = curTrainPre["id"].slice(0, 3);
    trainData.forEach((train) => {
        let trainType = train["id"].slice(0, 3);
        if (trainType === curType) {
            return;
        }
        
        let traint2 = "";
        let flagt2 = false;
        for (let planIdx = 0; planIdx < train["train"].length; planIdx++) {
            let plan = train["train"][planIdx];
            if (plan["dir"] !== curDir) {
                continue;
            }
            for (let stationIdx = 0; stationIdx < plan["plan"].length; stationIdx++) {
                let station = plan["plan"][stationIdx];
                if (planIdx === train["train"].length - 1 && stationIdx === plan["plan"].length - 1) {
                    continue;
                }
                if (station["station"] === stationId && station["t2"] >= curTime) {
                    traint2 = station["t2"];
                    flagt2 = true;
                    break;
                }
            }
            if (flagt2) {
                break;
            }
        }
        if (!flagt2) {
            return;
        }

        candidateDict[trainType] = {
            "id": train["id"],
            "terminal": train["train"][train["train"].length - 1]["plan"][train["train"][train["train"].length - 1]["plan"].length - 1]["station"],
            "t2": traint2,
            "color": train["color"],
            "subcolor": train["subcolor"],
            "platform": train["train"][0]["plan"][0]["platform"]
        };
    });
    
    let candidateList = Object.entries(candidateDict).sort((a, b) => a[1]["t2"] - b[1]["t2"]);
    candidateList = candidateList
                    .filter(candidate => getInterval(getTime(), candidate[1]["t2"]) <= 20 * 60)
                    .filter(candidate => getInterval(getTime(), candidate[1]["t2"]) >= 10);

    if (candidateList.length > 3) {
        candidateList = candidateList.slice(0, 3);
    }

    return candidateList;
}
async function displayB2(B2List, targetTime) {
    let l = B2List.length;
    let curTime = getTime();
    B2List.forEach((trans, idx) => {
        let i = idx + 1;
        let [trainNameZH, trainNameEN] = getTrainName(trans[1]["id"]);
        changeContent(`B2-${l}_type${i}-ZH`, trainNameZH);
        changeContent(`B2-${l}_type${i}-EN`, trainNameEN);
        let terminalStation = stationDataById[trans[1]["terminal"]];
        changeContent(`B2-${l}_text-terminal${i}-ZH`, terminalStation["name-ZH"]);
        changeContent(`B2-${l}_text-terminal${i}-EN`, terminalStation["name-EN"]);
        changeContent(`B2-${l}_text-t${i}`, Math.floor(getInterval(curTime, trans[1]["t2"]) / 60));
        changeContent(`B2-${l}_text-p${i}`, trans[1]["platform"]);
        changeBg(`B2-${l}_type${i}-ZH-frame`, trans[1]["color"]);
        changeBg(`B2-${l}_type${i}-EN-frame`, trans[1]["color"]);
    });

    reset(`B2-${l}`, [], true);
    if (l === 1) {
        addInnerShadowSvg("B2-inner-shadow", "B2-1_inner-shadow-1", 301, 14, 136, 69.5, "B2-1", false);
    } else if (l === 2) {
        addInnerShadowSvg("B2-inner-shadow", "B2-2_inner-shadow-1", 260, 14, 136, 69.5, "B2-2", false);
        addInnerShadowSvg("B2-inner-shadow", "B2-2_inner-shadow-2", 351, 14, 136, 69.5, "B2-2", false);
    } else if (l === 3) {
        addInnerShadowSvg("B2-inner-shadow", "B2-3_inner-shadow-1", 210, 14, 136, 69.5, "B2-3", false);
        addInnerShadowSvg("B2-inner-shadow", "B2-3_inner-shadow-2", 301, 14, 136, 69.5, "B2-3", false);
        addInnerShadowSvg("B2-inner-shadow", "B2-3_inner-shadow-3", 392, 14, 136, 69.5, "B2-3", false);
    }

    await sleep(Math.min(4 + 3 * l, getInterval(getTime(), targetTime)));
}

async function mainLoop() {
    // shadow
    addShadowSvg("SVG/A1-shadow.svg", "A1-shadow", "A1");
    addShadowSvg("SVG/A2-shadow.svg", "A2-shadow", "A2-line");
    addShadowSvg("SVG/B1-shadow.svg", "B1-shadow", "B1");
    addShadowSvg("SVG/B1-transfershadow.svg", "B1-transfershadow", "B1");
    addShadowSvg("SVG/B2-3-shadow.svg", "B2-3-shadow", "B2-3");
    addShadowSvg("SVG/B2-2-shadow.svg", "B2-2-shadow", "B2-2");
    addShadowSvg("SVG/B2-1-shadow.svg", "B2-1-shadow", "B2-1");

    // banner
    displayBanner();
    changeContent("A1_text-ZH", stationDataById[curTrain[curTrain.length - 1]["id"]]["name-ZH"]);
    changeContent("A1_text-EN", stationDataById[curTrain[curTrain.length - 1]["id"]]["name-EN"]);
    
    while (true) {
        let statusList = getStatus(getTime());
        let stationIdx = statusList[0];
        let status = statusList[1];
        if (status === "A") {
            let station = stationDataById[curTrain[stationIdx]["id"]];
            let targetTime = curTrain[stationIdx]["t1"];
            if(stationIdx === 0) {
                updateBanner(`发车时间 ${targetTime.slice(0,2)}:${targetTime.slice(2,4)}`, `Departure Time ${targetTime.slice(0,2)}:${targetTime.slice(2,4)}`, true);
            } else {
                updateBanner(station["name-ZH"], station["name-EN"]);
            }
            while (getTime() < targetTime) {
                // A1
                await displayA1(curTrain[stationIdx], 0, targetTime);
                // map-svg
                addFullScreenSvg("SVG/A1-map.svg", "A1-map-svg");
                let svgName = getSvgName(curTrainPre["id"]);
                // dot-svg
                addDotSvg(station["mappos"]);
                
                await sleep(0.5);
                addFullScreenSvg(`SVG/${svgName}.svg`, `${svgName}-svg`);
                for (let i = 0; i < 10; i++) {
                    showById(`${svgName}-svg`);
                    await sleep(0.5);
                    hideById(`${svgName}-svg`);
                    await sleep(0.5);
                    if (getTime() >= targetTime) {
                        break;
                    }
                }
                // A2
                if (getTime() >= targetTime) {
                    break;
                }
                let pastStations = curTrain.slice(0, stationIdx);
                let futureStations = curTrain.slice(stationIdx);
                await displayA2(pastStations, futureStations, targetTime);
            }
        } else if (status === "B") {
            let station = stationDataById[curTrain[stationIdx]["id"]];
            if (curTrain.length === stationIdx + 1) {
                updateBanner("终点站", "Terminal Station", 1);
            } else {
                updateBanner(stationDataById[curTrain[stationIdx + 1]["id"]]["name-ZH"], stationDataById[curTrain[stationIdx + 1]["id"]]["name-EN"]);
            }
            let targetTime = curTrain[stationIdx]["t2"];
            
            while (getTime() < targetTime) {
                let B2List = prepareB2(curTrain[stationIdx]["id"], curTrain[stationIdx]["dir"], curTrain[stationIdx]["t1"]);
                if (B2List.length === 0) {
                    // B1
                    await displayB1(station, 999999, targetTime);
                } else {
                    // B1
                    await displayB1(station, 6, targetTime);
                    B2List = prepareB2(curTrain[stationIdx]["id"], curTrain[stationIdx]["dir"], curTrain[stationIdx]["t1"]);
                    // B2
                    await displayB2(B2List, targetTime);
                }
            }
        } else {
            alert("本次列车运行结束");
            return;
        }
    }
}
async function showPrepare() {
    // prepare

    // const lineResponse = await fetch(lineJsonFile);
    // lineData = await lineResponse.json();
    // const trainResponse = await fetch(trainJsonFile);
    // trainData = await trainResponse.json();

    lineData["station"].forEach(station => {
        stationDataById[station["id"]] = station;
    });

    lineData["line"].forEach(line => {
        lineDataById[line["id"]] = line;
    });

    trainData.forEach(train => {
        trainDataById[train["id"]] = train;
    });

    // input and choose

    let curTrainList = [];
    let relaxedTrainList = [];
    trainData.forEach(train => {
        if (train["id"].startsWith(curTrainId)) {
            let curTime = getTime();
            if (train["train"][train["train"].length - 1]["plan"][train["train"][train["train"].length - 1]["plan"].length - 1]["t2"] >= curTime) {
                relaxedTrainList.push(train);
                if (train["train"][0]["plan"][0]["t1"] <= curTime) {
                    curTrainList.push(train);
                }
            }
        }
    });

    if (curTrainList.length === 0) {
        if(relaxedTrainList.length === 0) {
            alert(`Train with ID ${curTrainId} as prefix not found or not in service.`);
            return;
        }
        relaxedTrainList.forEach(train => {
            curTrainList.push(train);
        })
    }
    curTrainPre = curTrainList[Math.floor(Math.random() * curTrainList.length)];

    // console.log(curTrainPre["id"]);

    // construct
    curTrain = [];
    curTrainPre["train"].forEach(train => {
        train["plan"].forEach(plan => {
            curTrain.push({
                "id": plan["station"],
                "t1": plan["t1"],
                "t2": plan["t2"],
                "line": train["line"],
                "dir": train["dir"]
            });
        });
    });

    curLines = [];
    curTrainPre["train"].forEach(train => {
        curLines.push(train["line"]);
    });
}

function passTrain() {
    var passedTrain = []
    curTrain.forEach(plan => {
        passedTrain.push({
            "station": stationDataById[plan["id"]]["name-ZH"],
            "t1": `${plan["t1"].slice(0, 2)}:${plan["t1"].slice(2, 4)}:${plan["t1"].slice(4, 6)}`,
            "t2": `${plan["t2"].slice(0, 2)}:${plan["t2"].slice(2, 4)}:${plan["t2"].slice(4, 6)}`,
        })
    })
    // console.log(passedTrain)
    window.parent.passCurTrain(curTrainPre["id"], timeOffset, passedTrain);
}

async function coreMain() {
    await showPrepare();
    passTrain();
    if(curTrain) {
        await mainLoop();
    }
}
    </script>
</head>
<body>
    
    <div id="banner" class="module">
        <div class="BANNER_banner BANNER_banner_bg" id="BANNER_banner"></div>

        <div class="BANNER_frame BANNER_frame-type-zh" id="BANNER_frame-ZH">
            <div class="BANNER_text-type-zh" id="BANNER_text-type-zh"></div>
        </div>
        <div class="BANNER_frame BANNER_frame-type-en" id="BANNER_frame-EN">
            <div class="BANNER_text-type-en" id="BANNER_text-type-en"></div>
        </div>
        <div class="BANNER_frame BANNER_frame-ti" id="BANNER_frame-ti">
            <div class="BANNER_text-ti" id="BANNER_text-ti"></div>
        </div>

        <!-- <div class="BANNER_text BANNER_text-Wang">往</div> -->
        <div class="BANNER_text BANNER_text-Terminal-ZH" id="BANNER_text-Terminal-ZH">加载中</div>
        <div class="BANNER_text BANNER_text-Terminal-EN" id="BANNER_text-Terminal-EN">Loading...</div>
    </div>

    <div id="A1" class="module">
        <!-- <object type="image/svg+xml" data="SVG/A1-shadow.svg" class="shadow-svg" id="A1-shadow"></object> -->
        <div class="A1_text-Xia" style="left: 242px" id="A1_text-Xia">终点站</div>
        <div class="A1_text-ns" style="left: 242px" id="A1_text-ns">Terminal Station</div>

        <div class="A1_text-Xia" style="left: 522px" id="A1_text-ZH">终点站的名字</div>
        <div class="A1_text-ns" style="left: 522px" id="A1_text-EN">The Name of the Terminal Station</div>
    </div>

    <div id="A2-line" class="module">
        <!-- <object type="image/svg+xml" data="SVG/A2-shadow.svg" class="shadow-svg" id="A2-shadow"></object> -->
        <svg class="A2_line-svg" width="800" height="480" id="A2-line-svg">
            <polygon points="0,354 716,354 753,391 716,428 0,428 0,354" fill="#000000" />
        </svg>
    
        <div class="A2-LINE_frame_t0" style="top: 363px; left: 30px" id="A2-LINE_frame_0">
            <div class="A2-LINE_text" id="A2-LINE_t0"></div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 130px" id="A2-LINE_frame_1">
            <div class="A2-LINE_text" id="A2-LINE_t1">5</div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 230px" id="A2-LINE_frame_2">
            <div class="A2-LINE_text" id="A2-LINE_t2">?</div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 330px" id="A2-LINE_frame_3">
            <div class="A2-LINE_text" id="A2-LINE_t3">--</div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 430px" id="A2-LINE_frame_4">
            <div class="A2-LINE_text" id="A2-LINE_t4">620</div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 530px" id="A2-LINE_frame_5">
            <div class="A2-LINE_text" id="A2-LINE_t5">1440</div>
        </div>
        <div class="A2-LINE_frame_t1" style="top: 363px; left: 630px" id="A2-LINE_frame_6">
            <div class="A2-LINE_text" id="A2-LINE_t6">Time</div>
        </div>
    
        <div class="A2-LINE_seg0" style="top: 411px; left: 0px;" id="A2-LINE_seg_0"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 63px;" id="A2-LINE_seg_1"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 163px;" id="A2-LINE_seg_2"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 263px;" id="A2-LINE_seg_3"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 363px;" id="A2-LINE_seg_4"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 463px;" id="A2-LINE_seg_5"></div>
        <div class="A2-LINE_seg1" style="top: 411px; left: 563px;" id="A2-LINE_seg_6"></div>
        <div class="A2-LINE_seg2" style="top: 411px; left: 663px;" id="A2-LINE_seg_7"></div>
    </div>

    <div id="A2-EN" class="module">
        <div class="A2-EN_text_0" style="top: 165px; left: 40px" id="A2-EN_block_0">#0ENNNNNNNNNNNNNNNNN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 140px" id="A2-EN_block_1">#1EN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 240px" id="A2-EN_block_2">#2EN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 340px" id="A2-EN_block_3">#3EN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 440px" id="A2-EN_block_4">#4EN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 540px" id="A2-EN_block_5">#5EN</div>
        <div class="A2-EN_text_1" style="top: 165px; left: 640px" id="A2-EN_block_6">#6EN</div>
    </div>

    <div id="A2-ZH" class="module">
        <div class="A2-ZH_text_0" style="top: 155px; left: 40px" id="A2-ZH_block_0">一个STATION</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 140px" id="A2-ZH_block_1">这是另一个站</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 240px" id="A2-ZH_block_2">本站</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 340px" id="A2-ZH_block_3">站</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 440px" id="A2-ZH_block_4">这是站吗</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 540px" id="A2-ZH_block_5">这是站</div>
        <div class="A2-ZH_text_1" style="top: 155px; left: 640px" id="A2-ZH_block_6">我也是个站</div>
    </div>

    <div id="B1" class="module">
        <!-- <object type="image/svg+xml" data="SVG/B1-shadow.svg" class="shadow-svg" id="B1-shadow"></object>
        <object type="image/svg+xml" data="SVG/B1-transfershadow.svg" class="shadow-svg" id="B1-transfershadow"></object> -->
        <div class="B1_cur-ZH" style="top: 150px; left: 400px" id="B1_cur-ZH">在这里填写到达站点</div>
        <div class="B1_cur-EN" style="top: 320px; left: 400px" id="B1_cur-EN">Put the Name of the Current Station at this Position</div>
    </div>

    <div id="B2-3" class="module">
        <!-- <object type="image/svg+xml" data="SVG/B2-3-shadow.svg" class="shadow-svg" id="B2-3-shadow"></object> -->
        <div class="B2-3_frame B2-3_frame-type-zh B2-3_frame-type-zh-1" id="B2-3_type1-ZH-frame">
            <div class="B2-3_text-type-zh" id="B2-3_type1-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-3_frame B2-3_frame-type-en B2-3_frame-type-en-1" id="B2-3_type1-EN-frame">
            <div class="B2-3_text-type-en" id="B2-3_type1-EN">S6 Local</div>
        </div>
        <div class="B2-3_text-terminal-ZH" id="B2-3_text-terminal1-ZH" style="top: 210px">南郊小小小小小镇</div>
        <div class="B2-3_text-terminal-EN" id="B2-3_text-terminal1-EN" style="top: 258px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-3_text_t1" id="B2-3_text-t1">6</div>
        <div class="B2-3_text_p1" id="B2-3_text-p1">--</div>

        <div class="B2-3_frame B2-3_frame-type-zh B2-3_frame-type-zh-2" id="B2-3_type2-ZH-frame">
            <div class="B2-3_text-type-zh" id="B2-3_type2-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-3_frame B2-3_frame-type-en B2-3_frame-type-en-2" id="B2-3_type2-EN-frame">
            <div class="B2-3_text-type-en" id="B2-3_type2-EN">S6 Local</div>
        </div>
        <div class="B2-3_text-terminal-ZH" id="B2-3_text-terminal2-ZH" style="top: 301px">南郊小小小小小镇</div>
        <div class="B2-3_text-terminal-EN" id="B2-3_text-terminal2-EN" style="top: 349px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-3_text_t2" id="B2-3_text-t2">26</div>
        <div class="B2-3_text_p2" id="B2-3_text-p2">--</div>

        <div class="B2-3_frame B2-3_frame-type-zh B2-3_frame-type-zh-3" id="B2-3_type3-ZH-frame">
            <div class="B2-3_text-type-zh" id="B2-3_type3-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-3_frame B2-3_frame-type-en B2-3_frame-type-en-3" id="B2-3_type3-EN-frame">
            <div class="B2-3_text-type-en" id="B2-3_type3-EN">S6 Local</div>
        </div>
        <div class="B2-3_text-terminal-ZH" id="B2-3_text-terminal3-ZH" style="top: 392px">南郊小小小小小镇</div>
        <div class="B2-3_text-terminal-EN" id="B2-3_text-terminal3-EN" style="top: 440px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-3_text_t3" id="B2-3_text-t3">306</div>
        <div class="B2-3_text_p3" id="B2-3_text-p3">--</div>
    </div>

    <div id="B2-2" class="module">
        <!-- <object type="image/svg+xml" data="SVG/B2-2-shadow.svg" class="shadow-svg" id="B2-2-shadow"></object> -->
        <div class="B2-2_frame B2-2_frame-type-zh B2-2_frame-type-zh-1" id="B2-2_type1-ZH-frame">
            <div class="B2-2_text-type-zh" id="B2-2_type1-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-2_frame B2-2_frame-type-en B2-2_frame-type-en-1" id="B2-2_type1-EN-frame">
            <div class="B2-2_text-type-en" id="B2-2_type1-EN">S6 Local</div>
        </div>
        <div class="B2-2_text-terminal-ZH" id="B2-2_text-terminal1-ZH" style="top: 260px">南郊小小小小小镇</div>
        <div class="B2-2_text-terminal-EN" id="B2-2_text-terminal1-EN" style="top: 308px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-2_text_t1" id="B2-2_text-t1">6</div>
        <div class="B2-2_text_p1" id="B2-2_text-p1">--</div>

        <div class="B2-2_frame B2-2_frame-type-zh B2-2_frame-type-zh-2" id="B2-2_type2-ZH-frame">
            <div class="B2-2_text-type-zh" id="B2-2_type2-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-2_frame B2-2_frame-type-en B2-2_frame-type-en-2" id="B2-2_type2-EN-frame">
            <div class="B2-2_text-type-en" id="B2-2_type2-EN">S6 Local</div>
        </div>
        <div class="B2-2_text-terminal-ZH" id="B2-2_text-terminal2-ZH" style="top: 351px">南郊小小小小小镇</div>
        <div class="B2-2_text-terminal-EN" id="B2-2_text-terminal2-EN" style="top: 399px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-2_text_t2" id="B2-2_text-t2">26</div>
        <div class="B2-2_text_p2" id="B2-2_text-p2">--</div>
    </div>

    <div id="B2-1" class="module">
        <!-- <object type="image/svg+xml" data="SVG/B2-1-shadow.svg" class="shadow-svg" id="B2-1-shadow"></object> -->
        <div class="B2-1_frame B2-1_frame-type-zh B2-1_frame-type-zh-1" id="B2-1_type1-ZH-frame">
            <div class="B2-1_text-type-zh" id="B2-1_type1-ZH">S6各停停停停停停</div>
        </div>
        <div class="B2-1_frame B2-1_frame-type-en B2-1_frame-type-en-1" id="B2-1_type1-EN-frame">
            <div class="B2-1_text-type-en" id="B2-1_type1-EN">S6 Local</div>
        </div>
        <div class="B2-1_text-terminal-ZH" id="B2-1_text-terminal1-ZH" style="top: 301px">南郊小小小小小镇</div>
        <div class="B2-1_text-terminal-EN" id="B2-1_text-terminal1-EN" style="top: 349px">NANJIAO XIAOZHENENENENENENEN</div>
        <div class="B2-1_text_t1" id="B2-1_text-t1">26</div>
        <div class="B2-1_text_p1" id="B2-1_text-p1">--</div>
    </div>

    <script>
        setInterval(updateTime, 500);
        reset_module([], false, false);
        updateTextScale();
        timeOffset = getTimeOffset();   
        coreMain();
    </script>

</body>

</html>
